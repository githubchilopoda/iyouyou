function Messenger(a){this.win=a;this.init()}Messenger.prototype.init=function(){var a=this,b=function(c){if(c.source==a.win)(a.onmessage||function(){}).call(a,c.data)};if(window.addEventListener)window.addEventListener("message",b,false);else window.attachEvent&&window.attachEvent("onmessage",b)};Messenger.prototype.send=function(a){this.win.postMessage(a,"*")};Messenger.initInParent=function(a){return new this(a.contentWindow)};Messenger.initInIframe=function(){return new this(window.parent)};
if(!window.postMessage&&window.attachEvent){Messenger.prototype.init=function(){var a=false;try{a=!!this.win.location.href}catch(b){}if(a){this.send=this.sendForSameOrigin;this.initForSameOrigin()}else{this.queue=[];window.parent==this.win?this.initForParent():this.initForFrame()}};Messenger.prototype.initForSameOrigin=function(){var a=this;document.attachEvent("ondataavailable",function(b){!b.eventType||b.eventType!=="message"||b.eventSource!=a.win||(a.onmessage||function(){}).call(a,b.eventData)})};
Messenger.prototype.sendForSameOrigin=function(a){var b=this;setTimeout(function(){var c=b.win.document.createEventObject();c.eventType="message";c.eventSource=window;c.eventData=a;b.win.document.fireEvent("ondataavailable",c)})};Messenger.prototype.initForParent=function(){var a=document.createDocumentFragment(),b=document.createElement("iframe");b.style.cssText="width: 1px; height: 1px; position: absolute; left: -999px; top: -999px;";a.appendChild(b);var c=document.createElement("iframe");c.style.cssText=
"width: 1px; height: 1px; position: absolute; left: -999px; top: -999px;";a.appendChild(c);document.body.insertBefore(a,document.body.firstChild);this.senderWin=b.contentWindow;this.receiverWin=c.contentWindow;this.startReceive()};Messenger.prototype.initForFrame=function(){this.receiverWin=this.senderWin=null;var a=this;this.timerId=setInterval(function(){a.waitForFrame()},50)};Messenger.prototype.waitForFrame=function(){var a,b;try{a=this.win[1];b=this.win[0]}catch(c){}if(a&&b){clearInterval(this.timerId);
this.senderWin=a;this.receiverWin=b;this.queue.length&&this.flush();this.startReceive()}};Messenger.prototype.startReceive=function(){var a=this;this.timerId=setInterval(function(){a.tryReceive()},50)};Messenger.prototype.tryReceive=function(){try{this.receiverWin.name="";return}catch(a){}this.receiverWin.location.replace("about:blank");var b=this;setTimeout(function(){b.receive()},0)};Messenger.prototype.receive=function(){var a=null;try{a=this.receiverWin.name}catch(b){}if(a){this.receiverWin.name=
"";for(var c=this,d=a.substring(1).split("|"),e=0;e<d.length;e++)(function(){var f=decodeURIComponent(d[e]);setTimeout(function(){(c.onmessage||function(){}).call(c,f)},0)})()}};Messenger.prototype.send=function(a){this.queue.push(a);this.senderWin&&this.flush()};Messenger.prototype.flush=function(){for(var a=[],b=0;b<this.queue.length;b++)a[b]=encodeURIComponent(this.queue[b]);a="|"+a.join("|");try{this.senderWin.name+=a;this.queue.length=0}catch(c){this.senderWin.location.replace("about:blank");
var d=this;setTimeout(function(){d.flush()},0)}}};
